<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=generator content="Hugo 0.82.0"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Valentin Ouvrard"><meta property="og:url" content="https://valentin2105.github.io/opsnotice.xyz/post/kubernetes-ipv6-only/"><title>Kubernetes in IPv6 only - OpsNotice.xyz</title><meta property="og:title" content="Kubernetes in IPv6 only - OpsNotice.xyz"><meta property="og:type" content="article"><meta name=description content><link rel=stylesheet href=/opsnotice.xyz/css/fonts.css><link rel=stylesheet href=/opsnotice.xyz/css/highlight.css><link rel=stylesheet href=/opsnotice.xyz/css/journal.css><link href=/opsnotice.xyz/index.xml rel=alternate type=application/rss+xml title=OpsNotice.xyz></head><body><div class=container><nav class=site-nav><a href=https://valentin2105.github.io/opsnotice.xyz/>Index</a></nav><article class=post><header class=post-header><h1 class=post-title>Kubernetes in IPv6 only</h1><time class=post-date datetime="2017-11-14 09:53:14 UTC">14 Nov 2017</time></header><hr><p><img src=/content/images/2017/11/ipv6-world-4f186b8-intro.jpg alt></p><p>Since few weeks, I&rsquo;m working to deploy IPv6-only Kubernetes cluster in production for my company. Here is how I made it, maybe it will help you if you want to try this (tumultuous) adventure.</p><h2 id=i--kubernetes-installation>I- Kubernetes installation</h2><p>To put Kubernetes in production, I strongly recommend avoiding using automated installation script but instead, use a configuration management tool (Saltstack, Chef, Puppet&mldr;) to deploy Kubernetes from scratch like done in <strong>kubernetes-the-hard-way</strong> by the awesome <a href=https://github.com/kelseyhightower>Kelsey Hightower</a> (the k8s-dope guy).</p><p>This installation way, with a configuration manager, ensures that you always got your binaries and configuration present and consistent on your Kubernetes servers (master/worker/etcd) and make easy Kubernetes updates and rollback if needed.</p><p>In my case I deploy Kubernetes 1.8.x on Debian 9.x KVM virtual-machines with IPv6 only networking on a dedicated VLAN configured by Saltstack. I use Ferm (IPtables front-end) on each VMs to ensure strictly defined firewall rules (to restrain ETCD access for example).</p><p>Each Kubernetes components are IPv6 capable, so you can connect your API to your ETCD and then your Kubelets to your API and finally talk to your API with kubectl without any IPv4.</p><h2 id=ii--cni-configuration>II- C.N.I configuration</h2><p>You need to choose a CNI provider (Container Network Interface) to handle your Containers networking in Kubernetes. My choice was directly done for <strong>Project Calico</strong> which provide pure Layer 3 networking (Linux IP Routes) with BGP routes exchange between workers (pretty awesome).
<img src=/content/images/2017/11/MOiS-calico.png alt>
Calico allows you easily to enable IPv6 and also to totally disable IPv4 on your pod&rsquo;s side. Kubernetes networking with Calico is configured in the CNI configuration file (<code>/etc/cni/net.d/</code> by default) and come with the <strong>calicoctl</strong> tool that makes possible to create new IPPools in a running cluster. <strong>Calico-node</strong> run on every workers and need an ETCD access to store his states (can use the same as k8s).</p><p>By default Calico use a <a href=https://en.wikipedia.org/wiki/Unique_local_address>Unique Local Address</a> (ULA) IPv6 range. If you want to make quick tests with it, you need to allow NAT to make sure that your pod can talk to public IPv6 networks. To do that you need to delete the IPPool and then create the same (or another) with NAT enabled :</p><pre><code>calicoctl delete ippool fd80:24e2:f998:72d6::/64

cat &lt;&lt;EOF | calicoctl create -f -
- apiVersion: v1
  kind: ipPool
  metadata:
    cidr: fd80:24e2:f998:72d6::/64
  spec:
    nat-outgoing: true
EOF
</code></pre><p>In production way, you will not use a ULA IPv6 pool because in the version 6 of the IP protocol everything need to be public and without NAT (it&rsquo;s not a good practice to use NAT in IPv6).</p><p>To use public IPv6 networking for your pods, you need to configure a Calico&rsquo;s BGP Peer to announce to your company router your Pod&rsquo;s IPv6 routes handled by Kubernetes workers, it&rsquo;s done quite easily with a <code>.yaml</code> file like this :</p><pre><code>apiVersion: v1
kind: bgpPeer
metadata:
  peerIP: 2001:DB8:f::100
  scope: global
spec:
  asNumber: 65538

</code></pre><p>Calico breaks by default IPv6 pool into <strong>/122 by workers</strong> and randomly takes addresses from these pools according to the worker on which the pod is scheduled.</p><p>Another great feature of Calico is that you can indicate which IPPool you want to use in a pod Deployment definition with a simple annotation, for example :</p><pre><code>annotations:
      &quot;cni.projectcalico.org/ipv6pools&quot;: &quot;[\&quot;2001:db8::1/120\&quot;]&quot;
</code></pre><p>More references <a href=https://docs.projectcalico.org/v2.2/reference/cni-plugin/configuration>here</a>.</p><h2 id=iii--services-and-kube-dns>III- Services and Kube-DNS</h2><p>One of the biggest problems when using IPv6 cluster is about ClusterIP (<strong>10.32.0.0/16</strong> by default). You need to totally stop using them, by declaring <code>clusterIP: None</code> on every defined Service. With that, you can speak to your Service like <code>my-database.default.svc.cluster-domain.tld</code> which will be resolved with Service&rsquo;s IPv6 Endpoints instead of Service&rsquo;s ClusterIP.</p><blockquote><p>With Kubernetes in IPv6 only, Kube-Proxy become totally useless.</p></blockquote><p>Another small problem is that some Kubernetes applications try directly to talk to your API via <strong>10.32.0.1</strong> which for sure is unreachable.
To solve this problem you need to pass theses environment variables to your deployments :</p><pre><code>    - name: KUBERNETES_SERVICE_HOST
      value: public-api.domain.tld
    - name: KUBERNETES_SERVICE_PORT
      value: '6443'
</code></pre><p>If you plan to deploy Kubernetes with IPv6 in production, any good way to achieve a scalable kube-dns architecture, is to deploy a couple of DNS deployment (4 for example) using well-known defined IPv6 address (with Calico annotations) that allow you to get 4 non-changing public IPv6 that you can use in your DNS records as a NS delegation, to make your cluster domain resolution public.</p><p>With that, you&rsquo;re able to use public DNS (like <a href=https://developers.google.com/speed/public-dns/docs/using>IPv6 Google one</a>) in your Pods, and when you will try to speak to an internal domain name (<code>my-app.default.svc.cluster-domain.tld</code>) the DNS answers will be given by any of your Kube-DNS pods.</p><h2 id=iv--expose-services-to-users>IV- Expose services to users</h2><p>To expose my External Kubernetes services in IPv6-only I use the Nginx ingress-controller, that use Endpoint as virtual-host back end, so it works from scratch on IPv6 with latest image :</p><blockquote><p>gcr.io/google_containers/nginx-ingress-controller:0.9.0-beta.15</p></blockquote><p>I deploy a couple of Nginx-ingress in the cluster with well-known IPv6 that we can directly use in our DNS records to expose Services publicly. You can also use <strong>kube-lego</strong> to automatically fetch Let&rsquo;s Encrypt certificates.</p><p>If you want to expose external services in IPv4/6, you will need to setup an External LoadBalancer (like done in AWS or GCP) with a couple of High-Available Nginx or HAProxy with dual-stack networking pointing on this IPv6 only pods. It&rsquo;s what we do in our cluster.</p><h2 id=v--persistent-volumes>V- Persistent Volumes</h2><p>We mostly use GlusterFS as a persistent volume provider.</p><p>We were surprised to see that Gluster work in IPv6-only without any special tweaking. You need to configure it to bind on the wanted IP address, then you can peer your servers to create a Gluster cluster.</p><p>After that, you can easily create Persistent Volume on your Kubernetes cluster that point to external IPv6-only GlusterFS cluster.</p><p>To achieve this point you need to simply create a endpoint/service for your external Gluster cluster.</p><h2 id=vi--pods-security>VI- Pods security</h2><p>In this topology, all the pods can talk to each other. It&rsquo;s like a big swimming-pool for all your pods. It&rsquo;s not the best for security.</p><p>With Calico Policy Controller, you can define simple Network Policy (k8s) rules that say things like <code>nobody can talk to this namespace except pods with the label "my-frontend"</code>. It&rsquo;s like migrating from big swimming pool to a small private trusted jacuzzis.</p><p>The Policy controller work in IPv6-only from scratch using IP6tables.</p><h2 id=vii--conclusion>VII- Conclusion</h2><p>Deploying a production-wide IPv6-only Kubernetes cluster was a big challenge for us but a required step because we are working in IPv6-only VM network so it was impossible to keep IPv4 long time only for our containers without trying IPv6-only.</p><p>As you should know, IPv6 is not IPv4 compatible so to be able to reach IPv4 world from our version 6 network, we use <a href=http://jool.mx/en/index.html>Jool</a> to enable NAT64 at our DNS side to be able to join IPv4-only websites like the famous Github.com.</p><p>One last point that make IPv6-only not user-friendly is because, before try new services from Internet in our cluster, we need to make few changes to make it work like <code>clusterIP: None</code> Services and put the right environment variables if pods need to talk to k8s API. Otherwise, it&rsquo;s just pleasure.</p><p><img src=/content/images/2017/11/Screen-Shot-2017-11-14-at-16.25.07.png alt></p><blockquote><p>Let me know if you got any question !</p></blockquote><p>I would like to thank especially <a href=https://tigera.io/>Tigera</a> (the company behind <a href=https://www.projectcalico.org/>Project Calico</a>) for help provided and for the investigations on CNI problems I encountered. Thanks !</p></article><footer class=site-footer><span itemscope itemtype=http://schema.org/Person><link itemprop=url href=https://valentin2105.github.io/opsnotice.xyz/><span itemprop=name>Valentin Ouvrard</span>
,
<span itemprop=jobTitle>DevOps</span> at
<span itemprop=memberOf itemscope itemtype=http://schema.org/Organization><a itemprop=url href=https://www.nautile.nc><span itemprop=name>Nautile.nc</span></a></span><br><a itemprop=sameAs href=https://github.com/valentin2105 title=GitHub>GH</a>
<a itemprop=sameAs href=https://twitter.com/val_ouvrard title=Twitter>TW</a>
<a itemprop=sameAs href title="GPG  (fingerprint: )">GPG</a></span></footer></div><script src=/opsnotice.xyz/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad()</script></body></html>